// This is your Prisma schema file
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm]
}

// Головна сутність (Snapshot актуального стану)
model Person {
  id            String     @id @default(uuid())
  fullName      String
  currentRole   String?
  bio           String?    @db.Text
  photoUrl      String?
  status        Status     @default(PENDING)

  // Метрики (Scoring)
  reputation    Float      @default(0.0)
  influence     Float      @default(0.0)

  // Зв'язки
  revisions     Revision[]
  tags          Tag[]
  votes         Vote[]
  fundraisings  Fundraising[]

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([fullName(ops: raw("gin_trgm_ops"))], type: Gin)
}

// Ревізія — кожна правка створює новий запис
model Revision {
  id            String         @id @default(uuid())
  personId      String
  person        Person         @relation(fields: [personId], references: [id])

  authorId      String
  author        User           @relation(fields: [authorId], references: [id])

  // Дані, що пропонуються змінити
  proposedData  Json           // Зліпок змін: { fullName: "...", bio: "..." }
  reason        String?        @db.Text

  // Статус модерації
  status        Status         @default(PENDING)
  aiScore       Float?         // Результат перевірки AI (0-100)

  // Докази до цієї конкретної ревізії
  evidences     Evidence[]

  hashedIp      String?        // HMAC of client's IP (for Anti-Abuse)

  priorityScore  Int            @default(0)
  aiVotes        AiVote[]

  createdAt      DateTime       @default(now())
}

model AiVote {
  id            String   @id @default(uuid())
  revisionId    String
  revision      Revision @relation(fields: [revisionId], references: [id])
  userId        String   // pHash of the user
  user          User     @relation(fields: [userId], references: [id])

  createdAt     DateTime @default(now())
  @@unique([userId, revisionId])
}

// Докази (Медіа, Посилання, Документи)
model Evidence {
  id            String       @id @default(uuid())
  revisionId    String
  revision      Revision     @relation(fields: [revisionId], references: [id])

  type          EvidenceType @default(LINK)
  url           String       // S3 шлях або зовнішнє посилання
  title         String?

  // Чи цей доказ підтверджує (SUPPORT) чи спростовує (REFUTE) інформацію
  polarity      Polarity     @default(SUPPORT)

  createdAt     DateTime     @default(now())
}

// Система голосування за правки (Scoring)
model Vote {
  id            String   @id @default(uuid())
  personId      String
  person        Person   @relation(fields: [personId], references: [id])
  userId        String
  user          User     @relation(fields: [userId], references: [id])

  weight        Float    @default(1.0) // Вага голосу залежить від репутації юзера
  isUpvote      Boolean

  createdAt     DateTime @default(now())
  @@unique([userId, personId]) // Один юзер — один голос за особу
}

model User {
  id              String   @id // This is the pHash (HMAC of Telegram ID + Pepper)

  role            UserRole @default(USER)

  // Display name (Reddit-style generated username)
  displayName     String?
  
  // Avatar color (Google Sheets-style)
  avatarColor     String?

  // Encrypted PII: { username, firstName, lastName, photoUrl, etc. }
  encryptedData   String?

  // Secondary hash for anomaly detection
  mHash           String?

  // For shadow bans
  isShadowBanned  Boolean  @default(false)
  violationCount  Int      @default(0)

  // Store hashed IP only if user is flagged for abuse
  hashedFlaggedIp  String?

  reputation      Float    @default(10.0)
  createdAt       DateTime @default(now())

  revisions       Revision[]
  votes           Vote[]
  aiVotes         AiVote[]
  auditLogs       AuditLog[]
}

model Tag {
  id      String   @id @default(uuid())
  name    String   @unique
  persons Person[]
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String   // e.g., "APPROVE_REVISION", "BAN_USER"
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  details   Json?
  timestamp DateTime @default(now())
}

enum Status {
  PENDING
  QUEUED_FOR_AI
  PROCESSING
  APPROVED
  REJECTED
  ARCHIVED
}

enum EvidenceType {
  LINK
  IMAGE
  DOCUMENT
  VIDEO
  VOTE_RECORD // Спеціальний тип для результатів голосування в Раді
}

enum Polarity {
  SUPPORT
  REFUTE
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
}

// Збори коштів (Monobank, PayPal, Crypto etc)
model Fundraising {
  id              String             @id @default(uuid())
  personId        String
  person          Person             @relation(fields: [personId], references: [id])

  title           String
  description     String?            @db.Text
  targetAmount    Float?
  collectedAmount Float?             @default(0.0)
  currency        String             @default("UAH")

  provider        FundraisingProvider @default(OTHER)
  link            String

  isVerified      Boolean            @default(false)

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

enum FundraisingProvider {
  MONOBANK
  PAYPAL
  PATREON
  BUYMEACOFFEE
  CRYPTO
  OTHER
}